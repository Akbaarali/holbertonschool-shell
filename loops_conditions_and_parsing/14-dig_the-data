#!/usr/bin/env bash
# Display the number of occurrences of each (IP, HTTP status code) pair in apache-access.log

awk '
$1 ~ /^[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*$/ && $9 ~ /^[0-9][0-9][0-9]$/ {
  code = $9
  gsub(/\r/, "", code)

  n = split($1, a, /\./)
  if (n == 4) {
    key = sprintf("%03d.%03d.%03d.%03d", a[1], a[2], a[3], a[4])
    print key, $1, code
  }
}
' apache-access.log \
| sort -k1,1 -k3,3n \
| uniq -c \
| sort -k1,1nr -k2,2 -k4,4n \
| awk '{ print $1, $3, $4 }'
