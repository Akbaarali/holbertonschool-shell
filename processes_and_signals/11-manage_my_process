#!/usr/bin/env bash
# init-like script that starts/stops/restarts manage_my_process

DAEMON="./manage_my_process"
PIDFILE="/var/run/my_process.pid"

start_process() {
  nohup "$DAEMON" >/dev/null 2>&1 &
  echo "$!" > "$PIDFILE" 2>/dev/null || sudo sh -c "echo $! > '$PIDFILE'"
  echo "manage_my_process started"
}

stop_process() {
  # 1) Kill PID from pidfile if it exists
  if [ -f "$PIDFILE" ] || sudo test -f "$PIDFILE" 2>/dev/null; then
    PID="$(cat "$PIDFILE" 2>/dev/null || sudo cat "$PIDFILE" 2>/dev/null)"

    if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
      kill "$PID" 2>/dev/null || true
      sleep 0.2
      if kill -0 "$PID" 2>/dev/null; then
        kill -9 "$PID" 2>/dev/null || true
      fi
    fi
  fi

  # 2) Extra: kill any remaining manage_my_process instances
  # (checker often checks for any still running)
  for p in $(pgrep -f "[m]anage_my_process" 2>/dev/null); do
    kill "$p" 2>/dev/null || true
  done

  sleep 0.2

  for p in $(pgrep -f "[m]anage_my_process" 2>/dev/null); do
    kill -9 "$p" 2>/dev/null || true
  done

  # 3) Delete pidfile (handle symlinked /var/run -> /run)
  rm -f /var/run/my_process.pid /run/my_process.pid 2>/dev/null || true
  sudo rm -f /var/run/my_process.pid /run/my_process.pid 2>/dev/null || true

  echo "manage_my_process stopped"
}

restart_process() {
  stop_process >/dev/null 2>&1
  start_process >/dev/null 2>&1
  echo "manage_my_process restarted"
}

case "$1" in
  start)
    start_process
    ;;
  stop)
    stop_process
    ;;
  restart)
    restart_process
    ;;
  *)
    echo "Usage: manage_my_process {start|stop|restart}"
    exit 1
    ;;
esac
